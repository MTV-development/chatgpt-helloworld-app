<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Test Page - ChatGPT Hello World</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f0f0;
      min-height: 100vh;
      padding: 20px;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
    }
    h1 {
      margin-bottom: 20px;
      color: #333;
    }
    .controls {
      background: white;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls h2 {
      font-size: 14px;
      margin-bottom: 12px;
      color: #666;
    }
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    button.primary {
      background: #10a37f;
      color: white;
    }
    button.primary:hover {
      background: #0d8a6a;
    }
    button.secondary {
      background: #e5e5e5;
      color: #333;
    }
    button.secondary:hover {
      background: #d0d0d0;
    }
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .widget-frame {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .frame-header {
      background: #f7f7f8;
      padding: 12px 16px;
      border-bottom: 1px solid #e5e5e5;
      font-size: 12px;
      color: #666;
    }
    iframe {
      width: 100%;
      height: 550px;
      border: none;
    }
    .button-group-label {
      font-size: 11px;
      color: #999;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    button.dashboard {
      background: #667eea;
      color: white;
    }
    button.dashboard:hover {
      background: #5a67d8;
    }
    .log {
      background: #1a1a1a;
      color: #10a37f;
      padding: 16px;
      border-radius: 8px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 4px;
    }
    .log-entry.error { color: #ff6b6b; }
    .log-entry.info { color: #4dabf7; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>Widget Test Page</h1>
    <p style="margin-bottom: 20px; color: #666;">
      This page simulates the ChatGPT environment to test your widget locally.
      Click the buttons below to simulate tool responses.
    </p>

    <div class="controls">
      <h2>Simulate Tool Responses</h2>
      <div class="button-group-label">Basic Tools</div>
      <div class="button-group">
        <button class="primary" onclick="simulateGreeting()">Say Hello</button>
        <button class="primary" onclick="simulateFact()">Random Fact</button>
        <button class="primary" onclick="simulateCalculation()">Calculate (42 × 17)</button>
        <button class="primary" onclick="simulateTime()">Current Time</button>
      </div>
      <div class="button-group-label">Dashboard Tools</div>
      <div class="button-group">
        <button class="dashboard" onclick="simulateDashboard()">Sales Dashboard</button>
        <button class="dashboard" onclick="simulateRegionDetail()">Region Detail (NA)</button>
        <button class="dashboard" onclick="simulateTopProducts()">Top Products</button>
      </div>
      <div class="theme-toggle">
        <span>Theme:</span>
        <button class="secondary" onclick="setTheme('light')">Light</button>
        <button class="secondary" onclick="setTheme('dark')">Dark</button>
      </div>
    </div>

    <div class="widget-frame">
      <div class="frame-header">
        ChatGPT Widget Preview (iframe)
      </div>
      <iframe id="widget" src="app.html"></iframe>
    </div>

    <div class="log" id="log">
      <div class="log-entry info">[INFO] Test page loaded. Click buttons to simulate responses.</div>
    </div>
  </div>

  <script>
    let currentTheme = 'light';
    let currentToolOutput = null;

    function log(message, type = '') {
      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setupOpenAI(iframeWindow) {
      iframeWindow.openai = {
        theme: currentTheme,
        toolOutput: currentToolOutput,
        callTool: (name, args) => {
          log(`callTool invoked: ${name}(${JSON.stringify(args)})`, 'info');
          return Promise.resolve({ success: true });
        },
        sendFollowUp: (message) => {
          log(`sendFollowUp: "${message}"`, 'info');
        },
        setWidgetState: (state) => {
          log(`setWidgetState: ${JSON.stringify(state)}`, 'info');
        },
        getWidgetState: () => ({}),
      };
    }

    function updateWidget(toolOutput) {
      currentToolOutput = toolOutput;
      log(`Simulating: ${toolOutput.structuredContent?.type || 'unknown'} response`);

      const iframe = document.getElementById('widget');

      // Set up handler for when iframe reloads
      iframe.onload = () => {
        setupOpenAI(iframe.contentWindow);
        log('Widget updated with new data', 'info');
      };

      // Reload iframe to trigger fresh render with new data
      iframe.src = 'app.html?' + Date.now();
    }

    function simulateGreeting() {
      updateWidget({
        content: [{ type: 'text', text: 'Hello, Test User!' }],
        structuredContent: {
          type: 'greeting',
          name: 'Test User',
          timestamp: new Date().toISOString(),
          message: 'Hello, Test User!'
        }
      });
    }

    function simulateFact() {
      const facts = [
        "Honey never spoils. Archaeologists have found 3000-year-old honey in Egyptian tombs that was still edible!",
        "Octopuses have three hearts and blue blood.",
        "A group of flamingos is called a 'flamboyance'.",
        "Bananas are berries, but strawberries aren't."
      ];
      const fact = facts[Math.floor(Math.random() * facts.length)];

      updateWidget({
        content: [{ type: 'text', text: fact }],
        structuredContent: {
          type: 'fact',
          fact: fact,
          timestamp: new Date().toISOString()
        }
      });
    }

    function simulateCalculation() {
      updateWidget({
        content: [{ type: 'text', text: '42 × 17 = 714' }],
        structuredContent: {
          type: 'calculation',
          operation: 'multiply',
          a: 42,
          b: 17,
          result: 714,
          expression: '42 × 17 = 714'
        }
      });
    }

    function simulateTime() {
      const timeString = new Date().toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        timeZoneName: 'short'
      });

      updateWidget({
        content: [{ type: 'text', text: `Current time: ${timeString}` }],
        structuredContent: {
          type: 'time',
          timezone: 'local',
          formatted: timeString,
          iso: new Date().toISOString()
        }
      });
    }

    // Dashboard simulations
    function simulateDashboard() {
      updateWidget({
        content: [{ type: 'text', text: 'Sales Dashboard (YTD): Total revenue is $13.2M. North America leads with $5.6M.' }],
        structuredContent: {
          type: 'dashboard',
          period: 'ytd',
          totalSales: 13210000,
          regions: [
            { id: 'na', name: 'North America', color: '#10a37f', sales: 5610000 },
            { id: 'eu', name: 'Europe', color: '#3b82f6', sales: 3640000 },
            { id: 'apac', name: 'Asia Pacific', color: '#f59e0b', sales: 3370000 },
            { id: 'latam', name: 'Latin America', color: '#ef4444', sales: 1600000 }
          ],
          quarterly: [
            { quarter: 'Q1', na: 1250000, eu: 890000, apac: 720000, latam: 340000 },
            { quarter: 'Q2', na: 1380000, eu: 920000, apac: 810000, latam: 380000 },
            { quarter: 'Q3', na: 1420000, eu: 850000, apac: 890000, latam: 420000 },
            { quarter: 'Q4', na: 1560000, eu: 980000, apac: 950000, latam: 460000 }
          ],
          timestamp: new Date().toISOString()
        }
      });
    }

    function simulateRegionDetail() {
      updateWidget({
        content: [{ type: 'text', text: 'North America Sales: Total YTD revenue is $5.61M. Best month was Dec ($530K). Q4 vs Q3 growth: 9.9%.' }],
        structuredContent: {
          type: 'region_detail',
          region: { id: 'na', name: 'North America', color: '#10a37f' },
          monthlyData: [
            { month: 'Jan', sales: 380000 }, { month: 'Feb', sales: 420000 }, { month: 'Mar', sales: 450000 },
            { month: 'Apr', sales: 440000 }, { month: 'May', sales: 460000 }, { month: 'Jun', sales: 480000 },
            { month: 'Jul', sales: 470000 }, { month: 'Aug', sales: 490000 }, { month: 'Sep', sales: 460000 },
            { month: 'Oct', sales: 510000 }, { month: 'Nov', sales: 520000 }, { month: 'Dec', sales: 530000 }
          ],
          totalSales: 5610000,
          avgMonthlySales: 467500,
          bestMonth: { month: 'Dec', sales: 530000 },
          worstMonth: { month: 'Jan', sales: 380000 },
          qoqGrowth: 9.9,
          timestamp: new Date().toISOString()
        }
      });
    }

    function simulateTopProducts() {
      updateWidget({
        content: [{ type: 'text', text: 'Top 5 Products (by sales): Widget Pro leads with $2.45M in sales (+15.2% growth).' }],
        structuredContent: {
          type: 'top_products',
          products: [
            { id: 1, name: 'Widget Pro', category: 'Premium', sales: 2450000, units: 12000, growth: 15.2 },
            { id: 2, name: 'Widget Basic', category: 'Standard', sales: 1820000, units: 28000, growth: 8.5 },
            { id: 3, name: 'Widget Enterprise', category: 'Premium', sales: 1650000, units: 3200, growth: 22.1 },
            { id: 4, name: 'Widget Lite', category: 'Budget', sales: 980000, units: 45000, growth: -2.3 },
            { id: 5, name: 'Widget Cloud', category: 'SaaS', sales: 890000, units: 8500, growth: 45.8 }
          ],
          sortBy: 'sales',
          totalRevenue: 7790000,
          timestamp: new Date().toISOString()
        }
      });
    }

    function setTheme(theme) {
      currentTheme = theme;
      log(`Theme changed to: ${theme}`, 'info');

      const iframe = document.getElementById('widget');

      // Set up handler for when iframe reloads
      iframe.onload = () => {
        setupOpenAI(iframe.contentWindow);
        log('Theme applied', 'info');
      };

      // Reload to apply theme
      iframe.src = 'app.html?' + Date.now();
    }

    // Initialize
    window.onload = () => {
      const iframe = document.getElementById('widget');
      iframe.onload = () => {
        setupOpenAI(iframe.contentWindow);
        log('Widget iframe loaded and initialized', 'info');
      };
    };
  </script>
</body>
</html>
